{% extends 'base.html' %}
{% load static %}

{% block content %}

<h5 class="mb-3 fw-bold text-primary">Informaci√≥n del Pedido</h5>

<input type="hidden" id="id_pedido" value="{{ pedido.id }}">

<!-- DATOS DEL CLIENTE -->
<div class="row g-1">

    <div class="col-12 col-md-4 col-lg-3">
        <label class="label-title">Fecha:</label>
        <input class="form-control input-black"
               value="{{ fecha_pedido|date:'d/m/Y H:i:s' }}"
               readonly>
    </div>

    <div class="col-12 col-md-3 col-lg-2">
        <label class="label-title">RFC:</label>
        <input class="form-control input-black"
               value="{{ clientes.rfc }}"
               readonly>
    </div>

    <div class="col-12 col-md-2 col-lg-1">
        <label class="label-title">Cliente:</label>
        <input class="form-control input-black"
               value="{{ clientes.idcliente }}"
               readonly>
    </div>

    <div class="w-100 d-none d-md-block d-lg-none"></div>

    <div class="col-12 col-md-6 col-lg-4">
        <label class="label-title">Nombre:</label>
        <input class="form-control input-black"
               value="{{ clientes.razon_social }}"
               readonly>
    </div>

    <div class="col-12 col-md-3 col-lg-1">
        <label class="label-title">Ruta:</label>
        <input class="form-control input-black"
               value="{{ clientes.ruta }}"
               readonly>
    </div>

    <div class="col-12 col-md-3 col-lg-2">
        <label class="label-title">Evento:</label>
        <select id="evento" class="form-select input-black">
            {% for e in evento %}
            <option value="{{ e.1 }}"
                {% if pedido.evento == e.1 %}selected{% endif %}>
                {{ e.1 }} - {{ e.0 }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="mt-2">
    <textarea id="observaciones"
              class="form-control input-black"
              placeholder="Observaciones del Pedido">{{ pedido.observaciones|default:'' }}</textarea>
</div>

<!-- BUSCADOR -->
<div class="mt-4">

    <div class="row g-2 align-items-end">

        <!-- BUSCADOR -->
        <div class="col-12 col-md-8 col-lg-6">
            <input id="buscador"
                   type="text"
                   class="form-control input-black"
                   placeholder="Buscar producto por nombre o c√≥digo‚Ä¶">
        </div>

        <!-- BOT√ìN -->
        <div class="col-12 col-md-4 col-lg-3">
            <button class="btn btn-outline-primary w-100"
                onclick="irSeleccionMultiple()">
                <i class="bi bi-list-check"></i>
                Selecci√≥n m√∫ltiple
            </button>
        </div>

    </div>

    <!-- RESULTADOS (siempre debajo y ancho completo) -->
    <div id="resultados" class="resultados-busqueda mt-2"></div>

</div>


<!-- TABLA PRODUCTOS -->
<div class="productos-wrapper mt-3">

    <div class="productos-header text-center fw-semibold">
        Lista de productos en el pedido actual
    </div>

    <div class="productos-body">
        <table id="tabla-producto"
               class="table table-sm table-products text-center mb-0">
            <thead>
                <tr>
                    <th style="width:60%">Producto</th>
                    <th>Unitario</th>
                    <th>Cant</th>
                    <th>Bon</th>
                    <th>D1%</th>
                    <th>D2%</th>
                    <th>Subtotal</th>
                    <th>Importe</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- TOTAL -->
<div class="d-flex justify-content-end mt-3">
    <div class="total-box">
        TOTAL: $<span id="totalGeneral">0.00</span>
    </div>
</div>

<!-- BOTONES -->
<div class="d-flex justify-content-between mt-3">
    <button class="btn btn-success" onclick="guardarPedido()">
        <i class="bi bi-save"></i> Guardar Pedido
    </button>

    <button class="btn btn-danger" onclick="confirmarCancelacion()">
        <i class="bi bi-x-circle"></i> Cancelar
    </button>
</div>

<!-- MODAL HISTORICO DEL PRODUCTO -->
<div class="modal fade" id="modalHistorico" tabindex="-1"> 
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable modal-historico-wide"> 
        <div class="modal-content modal-historico"> 
            <!-- HEADER --> 
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="bi bi-clock-history fs-4"></i> Hist√≥rico del producto 
                </h5> 
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> 
            </div> 
            <!-- BODY --> 
            <div class="modal-body"> 
                <div class="table-responsive historico-scroll"> 
                    <table class="table table-borderless table-hover align-middle text-nowrap historico-table"> 
                        <thead> 
                            <tr> 
                                <th>Fecha</th>
                                <th>Idcliente</th> 
                                <th class="d-none d-md-table-cell">Cliente</th> 
                                <th>C√≥digo</th> 
                                <th class="d-none d-md-table-cell">Producto</th> 
                                <th>Precio</th> 
                                <th>Cant.</th> 
                                <th class="d-none d-md-table-cell">Bon</th> 
                                <th class="d-none d-md-table-cell">D1</th> 
                                <th class="d-none d-md-table-cell">D2</th> 
                                <th class="text-end">Total</th> 
                            </tr> 
                        </thead> 
                        <tbody id="tablaHistorico"> <!-- JS --> </tbody> 
                    </table> 
                </div> 
            </div> 
            <!-- FOOTER --> 
            <div class="modal-footer justify-content-between small text-muted"> 
                <span> <i class="bi bi-info-circle"></i> Precios hist√≥ricos del cliente </span> 
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal"> Cerrar </button> 
            </div> 
        </div> 
    </div> 
</div>

<!-- MODAL COMENTARIO PRODUCTO -->

 <div class="modal fade" id="modalComentario" tabindex="-1"> 
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content modal-historico">

            <!-- HEADER -->
            <div class="modal-header bg-primary text-white"> 
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="bi bi-chat-left-text fs-4">
                    </i> Observaciones del producto 
                </h5> 
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> 
            </div> 

            <!-- BODY -->
            <div class="modal-body"> 
                <label class="form-label small text-muted mb-1">
                     Comentario 
                </label> 
                <textarea id="comentarioProducto" class="form-control comentario-textarea" rows="5" placeholder="Escribe aqu√≠ una observaci√≥n para este producto..."></textarea>
                 <div class="form-text mt-2">Este comentario se guardar√° junto al producto en el pedido.</div> 
            </div> 

            <!-- FOOTER --> 
            <div class="modal-footer justify-content-between">
                <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal"> Cancelar </button> 
                <button class="btn btn-success btn-sm" onclick="guardarComentario()"> <i class="bi bi-check-lg"></i>
                    Guardar 
                </button> 
            </div> 
        </div> 
    </div> 
</div> 

<!-- MODAL ELIMINAR PRODUCTO -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-eliminar">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center gap-2">
          <i class="bi bi-trash fs-4"></i>
          Eliminar producto
        </h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <p class="mb-1 fw-semibold">
          ¬øSeguro que deseas eliminar este producto del pedido?
        </p>
        <small class="text-muted">
          Esta acci√≥n no se puede deshacer.
        </small>
      </div>

      <div class="modal-footer justify-content-between">
        <button class="btn btn-outline-secondary btn-sm"
                data-bs-dismiss="modal">
          Cancelar
        </button>

        <button class="btn btn-danger btn-sm"
                onclick="confirmarEliminarProducto()">
          <i class="bi bi-trash"></i>
          Eliminar
        </button>
      </div>

    </div>
  </div>
</div>

{{ productos|json_script:"productos-data" }}

<script>
// =====================================================
// VARIABLES GLOBALES
// =====================================================
let filaActualComentario = null;
let filaActualEliminar = null;

// FUNCION QUE LE DA FORMATO A LAS CIFRAS GRANDES 
function money_es(value) {
    let number = parseFloat(value);
    if (isNaN(number)) return value;
    return number.toLocaleString('es-MX', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// =====================================================
// BUSCADOR DE PRODUCTOS Y MUESTRA LOS DATOS QUE SE AGREGAN DENTRO DEL PEDIDO
// =====================================================
const buscador = document.getElementById("buscador");
const resultados = document.getElementById("resultados");

buscador.addEventListener("keyup", function () {
    let query = this.value.trim();

    if (query.length < 1) {
        resultados.innerHTML = "";
        return;
    }

    fetch("{% url 'buscar_productos' %}?q=" + encodeURIComponent(query))
        .then(r => r.json())
        .then(data => {

            if (data.length === 0) {
                resultados.innerHTML = `
                    <div class="list-group-item text-muted">
                        No se encontraron productos
                    </div>`;
                return;
            }

            let html = "";

            data.forEach(p => {
                html += `
                    <div class="list-group-item product-item d-flex justify-content-between align-items-center">

                        <div class="product-info">
                            <strong>
                                ${resaltar(p.codigo)} - ${resaltar(p.nombre, query)}
                            </strong><br>
                            <small class="text-muted">
                                ${p.presentacion} | ${p.linea}
                            </small>
                        </div>

                        <div class="product-right">

                            <!-- PRECIO -->
                            <span class="product-price-green">
                                $${money_es(p.publico)}
                            </span>

                            <!-- BOT√ìN AZUL -->
                            <button type="button"
                                class="btn-add-blue"
                                title="Agregar al pedido"
                                onclick="agregarProducto(
                                    '${p.codigo}',
                                    '${p.nombre}',
                                    '${p.presentacion}',
                                    '${p.publico}',
                                    '${p.descripcion}',
                                    '${p.linea}'
                                )">
                                <i class="bi bi-plus-lg"></i>
                            </button>

                        </div>

                    </div>

                `;
            });

            resultados.innerHTML = html;
        });
});

// Resalta el texto buscado
function resaltar(texto, busqueda) {
    let regex = new RegExp(`(${busqueda})`, "ig");
    return texto.replace(regex, `<mark>$1</mark>`);
}

// FUNCION PARA LA SELECCION MULTIPLE

function irSeleccionMultiple() {
    const idPedido = document.getElementById("id_pedido").value;
    window.location.href = `/pedidos/seleccion_multiple/${idPedido}/`;
}


// =====================================================
// AGREGAR PRODUCTO PARA CUANDO TU VUELVAS A CARGAR EL PEDIDO LOS PRODUCTOS SIGAN APARECIENDO
// =====================================================


function agregarProducto(codigo, nombre, presentacion, publico, descripcion, linea) {
    let tbody = document.querySelector("#tabla-producto tbody");

    let fila = document.createElement("tr");

    // ESTE APARTADO AYUDA A MOSTRAR EL COMENTARIO GUARDADO DENTRO DEL PRODUCTOY EL ESPACIO ES PARA QUE NO SE AGREGUE ALGUN DATO DE CODIGO Y SE QUEDE VACIO
    fila.setAttribute("data-comentario", "");

    fila.innerHTML = `
        <td class="text-center">
            <div class="producto-nombre text-start">${codigo} - ${nombre} | ${descripcion} - ${linea}</div>

            <div class="producto-acciones">
                <button class="btn btn-sm btn-info"
                        onclick="abrirModalHistorico(this)">
                    <i class="bi bi-card-list"></i>
                </button>
        
                <button class="btn btn-sm btn-warning"
                        onclick="abrirModalComentario(this)">
                    <i class="bi bi-chat-left-text"></i>
                </button>

                <button class="btn btn-sm btn-danger"
                        onclick="abrirModalEliminar(this)">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>    
        </td>

        <td>
            <input class="form-control form-control-sm precio"
                   data-valor="${publico}"
                   value="${money_es(publico)}"
                   readonly>
        </td>

        <td>
            <input class="form-control form-control-sm cantidad"
                   value="1"
                   onchange="calcularFila(this)">
        </td>

        <td>
            <input class="form-control form-control-sm bon"
                   value="0"
                   onchange="calcularFila(this)">
        </td>

        <td>
            <input class="form-control form-control-sm d1"
                   value="0"
                   onchange="calcularFila(this)">
        </td>

        <td>
            <input class="form-control form-control-sm d2"
                   value="0"
                   onchange="calcularFila(this)">
        </td>

        <td class="subtotal">
            <input type="text"
                class="form-control form-control-sm text-end input-money subtotal-input"
                value="${money_es(0)}"
                readonly>
        </td>

        <td class="importe">
            <input type="text"
                class="form-control form-control-sm text-end input-money importe-input"
                value="${money_es(0)}"
                readonly>
        </td>

    `;

    tbody.appendChild(fila);

    // Recalcula con el valor correcto
    calcularFila(fila.querySelector(".cantidad"));

    // Limpia buscador
    document.getElementById("resultados").innerHTML = "";
    document.getElementById("buscador").value = "";
}

// =====================================================
// ABRIR MODAL DE COMENTARIO
// =====================================================
function abrirModalComentario(btn) {
    filaActualComentario = btn.closest("tr");

    let comentario =
        filaActualComentario.getAttribute("data-comentario") || "";

    document.getElementById("comentarioProducto").value = comentario;

    let modal = new bootstrap.Modal(
        document.getElementById("modalComentario")
    );
    modal.show();
}


// =====================================================
// GUARDAR COMENTARIO DEL MODAL
// =====================================================
function guardarComentario() {
    let texto = document.getElementById("comentarioProducto").value;

    filaActualComentario.setAttribute("data-comentario", texto);

    calcularFila(
        filaActualComentario.querySelector(".cantidad")
    ); // üëà fuerza autosave

    bootstrap.Modal.getInstance(
        document.getElementById("modalComentario")
    ).hide();
}


// =====================================================
// ABRIR MODAL DE HISTORICO
// =====================================================
function abrirModalHistorico(btn) {
    let tr = btn.closest("tr");
    let codigo = tr.cells[0].innerText.split(" - ")[0];

    fetch(`{% url 'historico_producto' %}?idcliente={{ clientes.idcliente }}&codigo=${codigo}`)
        .then(r => r.json())
        .then(data => {
            let tbody = document.getElementById("tablaHistorico");
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-muted">
                            Sin historial de ventas
                        </td>
                    </tr>`;
            } else {
                data.forEach(h => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${h.fecha}</td>
                            <td>${h.pedido}</td>
                            <td>${h.razon_social}</td>
                            <td>${h.clave}</td>
                            <td>${h.nombre}</td>
                            <td>$${money_es(h.precio)}</td>
                            <td>${h.cantidad}</td>
                            <td>${h.bonificacion}</td>
                            <td>${h.d1}%</td>
                            <td>${h.d2}%</td>
                            <td class="text-end">$${money_es(h.subtotal)}</td>
                        </tr>`;
                });
            }

            new bootstrap.Modal(
                document.getElementById("modalHistorico")
            ).show();
        });
}

// =====================================================
// MODAL PARA ELIMINAR PRODUCTO
// =====================================================

function abrirModalEliminar(btn) {
    filaActualEliminar = btn.closest("tr");

    new bootstrap.Modal(
        document.getElementById("modalEliminar")
    ).show();
}

// =====================================================
// CONFIRMAR MODAL PARA ELIMINAR PRODUCTO
// =====================================================

function confirmarEliminarProducto() {

    if (!filaActualEliminar) return;

    const codigo = filaActualEliminar
        .cells[0].innerText.split(" - ")[0];

    const idPedido = document.getElementById("id_pedido").value;

    // eliminar del DOM
    filaActualEliminar.remove();
    filaActualEliminar = null;

    // recalcular total
    calcularTotalGeneral();

    // eliminar en BD
    fetch("{% url 'eliminar_producto_pedido' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            id_pedido: idPedido,
            codigo: codigo
        })
    });

    // cerrar modal
    bootstrap.Modal.getInstance(
        document.getElementById("modalEliminar")
    ).hide();
}

// =====================================================
// CALCULAR SUBTOTAL / IMPORTE POR FILA
// =====================================================
function calcularFila(el) {
    let tr = el.closest("tr");

    let precio = parseFloat(
        tr.querySelector(".precio").dataset.valor
    ) || 0;

    let cant = parseFloat(tr.querySelector(".cantidad").value) || 0;
    let d1   = parseFloat(tr.querySelector(".d1").value) || 0;
    let d2   = parseFloat(tr.querySelector(".d2").value) || 0;

    let subtotal = precio * cant;

    let desc1 = subtotal * (d1 / 100);
    let desc2 = subtotal * (d2 / 100);

    let importe = subtotal - desc1 - desc2;

    // Mostrar FORMATEADO
    tr.querySelector(".subtotal-input").value = money_es(subtotal);
    tr.querySelector(".importe-input").value  = money_es(importe);

    calcularTotalGeneral();
    autoGuardarBorrador();
}


// =====================================================
// TOTAL GENERAL
// =====================================================
function calcularTotalGeneral() {
    let total = 0;

    document.querySelectorAll(".importe-input").forEach(input => {
        let valor = input.value.replace(/,/g, '');
        total += parseFloat(valor) || 0;
    });


    document.getElementById("totalGeneral").innerText = money_es(total);
}

// ====================================================
// MANDAR DATOS PARA LA DB
// ====================================================
function guardarPedido() {

    let filas = document.querySelectorAll("#tabla-producto tbody tr");

    if (filas.length === 0) {
        alert("Agrega al menos un producto");
        return;
    }

    let pedido = {
        id_pedido: document.getElementById("id_pedido").value,  
        idcliente: "{{ clientes.idcliente }}",
        ruta: "{{ clientes.ruta }}",
        evento: document.querySelector("select").value,
        observaciones: document.querySelector(
            "textarea[placeholder='Observaciones del Pedido']"
        ).value,
        total: document.getElementById("totalGeneral").innerText.replace(/,/g, ''),
        productos: []
    };


    filas.forEach(tr => {
        pedido.productos.push({
            codigo: tr.cells[0].innerText.split(" - ")[0],
            nombre: tr.cells[0].innerText.split(" - ")[1],
            precio: tr.querySelector(".precio").value.replace(/,/g, ''),
            cantidad: tr.querySelector(".cantidad").value,
            d1: tr.querySelector(".d1").value,
            d2: tr.querySelector(".d2").value,
            subtotal: tr.querySelector(".subtotal-input").value.replace(/,/g, ''),
            importe: tr.querySelector(".importe-input").value.replace(/,/g, ''),
            observaciones: tr.getAttribute("data-comentario")
        });
    });

    fetch("{% url 'guardar_pedido' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(pedido)
    })
    .then(r => r.json())
    .then(resp => {
        if (resp.ok) {
            alert("Pedido guardado con folio " + resp.id_pedido);
            window.location.href = "{% url 'consultar_pedidos' %}";
        } else {
            alert("Error al guardar pedido");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error de comunicaci√≥n con el servidor");
    });
}
// ESTE APARTADO ES UNICAMENTE CUANDO VUELVES A RETOMAR EL PEDIDO
function agregarProductoExistente(p) {
    agregarProducto(
        p.codigo,
        p.nombre,
        p.presentacion || "",
        p.precio,
        p.descripcion || "",
        p.linea || "",
        p.observaciones || ""
    );

    let fila = document.querySelector("#tabla-producto tbody tr:last-child");

    fila.querySelector(".precio").dataset.valor = p.precio;
    fila.querySelector(".precio").value = money_es(p.precio);

    fila.querySelector(".cantidad").value = p.cantidad || 1;
    fila.querySelector(".bon").value = p.bon || 0;
    fila.querySelector(".d1").value = p.d1 || 0;
    fila.querySelector(".d2").value = p.d2 || 0;

    if (p.observaciones) {
        fila.setAttribute("data-comentario", p.observaciones);
    }

    calcularFila(fila.querySelector(".cantidad"));
}

// =======================================
// CARGAR PRODUCTOS GUARDADOS DEL PEDIDO
// =======================================
document.addEventListener("DOMContentLoaded", () => {

    // 1. Productos ya guardados del pedido
    const productosGuardados = JSON.parse(
        document.getElementById("productos-data").textContent
    );

    productosGuardados.forEach(p => {
        agregarProductoExistente(p);
    });

    // 2. Productos seleccionados desde selecci√≥n m√∫ltiple
    const seleccionados = {{ productos_seleccion|default:"[]"|safe }};

    seleccionados.forEach(p => {
        agregarProducto(
            p.codigo,
            p.nombre,
            "",
            p.precio_unitario,
            p.descripcion,
            p.linea
        );
    });

});

// ----- GUARDA EL PEDIDO -------
let pedido = {
    id_pedido: document.getElementById("id_pedido").value,
    idcliente: "{{ clientes.idcliente }}",
    ruta: "{{ clientes.ruta }}",
    evento: document.querySelector("select").value,
    observaciones: document.querySelector(
        "textarea[placeholder='Observaciones del Pedido']"
    ).value,
    total: document.getElementById("totalGeneral")
            .innerText.replace(/,/g, ''),
    productos: []
};

// ------ CANCELACION DE PEDIDO -----

function confirmarCancelacion() {
    if (confirm("¬øSeguro que deseas cancelar este pedido?")) {
        window.location.href = "{% url 'cancelar_pedido' pedido.id %}";
    }
}


// ------- AUTO GUARDADO DE PRODUCTOS -----

let autosaveTimer = null;

function autoGuardarBorrador() {
    clearTimeout(autosaveTimer);

    autosaveTimer = setTimeout(() => {
        let filas = document.querySelectorAll("#tabla-producto tbody tr");

        let pedido = {
            id_pedido: document.getElementById("id_pedido").value,
            productos: []
        };

        filas.forEach(tr => {
            pedido.productos.push({
                codigo: tr.cells[0].innerText.split(" - ")[0],
                nombre: tr.cells[0].innerText.split(" - ")[1],
                precio: tr.querySelector(".precio").value.replace(/,/g, ''),
                cantidad: tr.querySelector(".cantidad").value,
                d1: tr.querySelector(".d1").value,
                d2: tr.querySelector(".d2").value,
                subtotal: tr.querySelector(".subtotal-input").value.replace(/,/g, ''),
                importe: tr.querySelector(".importe-input").value.replace(/,/g, ''),
                observaciones: tr.getAttribute("data-comentario")
            });
        });

        fetch("{% url 'guardar_borrador_pedido' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(pedido)
        });

    }, 800); // debounce
}

</script>

{% endblock %}
